services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    tty: true
    stdin_open: true
    # directly starts the aggregator server
    command: sh -c "pnpm install --force && pnpm run migration:run && pnpm run build:adapters && pnpm run start:dev"
    environment:
      MODE: DEV
      BINDING: "0.0.0.0"
      COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
      POSTGRES_DATABASE: ${POSTGRES_DB:-oer-aggregator-dev}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-oer-aggregator-password}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-oer-aggregator-user}
      NOSTR_RELAY_URLS: ${NOSTR_RELAY_URLS}
      NOSTR_AMB_RELAY_URL: ${NOSTR_AMB_RELAY_URL}
      NOSTR_INGEST_ENABLED: ${NOSTR_INGEST_ENABLED:-false}
      ENABLED_ADAPTERS: ${ENABLED_ADAPTERS:-nostr-amb-relay}
      RPI_VIRTUELL_API_URL: ${RPI_VIRTUELL_API_URL:-}
      IMGPROXY_BASE_URL: ${IMGPROXY_BASE_URL}
      IMGPROXY_KEY: ${IMGPROXY_KEY:-}
      IMGPROXY_SALT: ${IMGPROXY_SALT:-}
    ports:
      - "3001:3001"
    volumes:
      - .:/home/node/app
    depends_on:
      - postgres

  postgres:
    image: postgres:15-alpine
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: ${POSTGRES_DB:-oer-aggregator-dev}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-oer-aggregator-password}
      POSTGRES_USER: ${POSTGRES_USER:-oer-aggregator-user}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data/pgdata

  # nak-relay: Local Nostr relay for development/testing
  # NOTE: Can also be run directly on the host, requires Go to build. 
  # On Windows, clone repo and build manually:
  #   git clone https://github.com/fiatjaf/nak.git
  #   cd nak && go build -o nak.exe
  # Or use the external relays defined in NOSTR_RELAY_URLS instead
  nak-relay:
    build:
      # run on host vs. as docker container
      # context: ./nak-relay-build
      context: https://github.com/jannikstreek/nak.git#fix/docker-go-version
      dockerfile: Dockerfile
    command: serve --hostname 0.0.0.0
    ports:
      - "2700:2700"
      - "10547:10547"
    restart: unless-stopped
    volumes:
      - ./nak-data:/data
    environment:
      - NAK_DATA_DIR=/data

  imgproxy:
    image: ghcr.io/imgproxy/imgproxy:latest
    # network_mode: host does not work on Windows/macOS, use port mapping instead
    ports:
      - "8080:8080"
    restart: unless-stopped
    environment:
      # Port configuration (default: 8080)
      IMGPROXY_BIND: ${IMGPROXY_BIND:-:8080}

      # Security: URL signature keys (highly recommended for production)
      # Generate with: echo $(xxd -g 2 -l 64 -p /dev/random | tr -d '\n')
      IMGPROXY_KEY: ${IMGPROXY_KEY:-}
      IMGPROXY_SALT: ${IMGPROXY_SALT:-}

      # Enable URL source processing (required for proxying external images)
      IMGPROXY_ALLOW_ORIGIN: ${IMGPROXY_ALLOW_ORIGIN:-*}

      # Performance and resource limits
      IMGPROXY_MAX_SRC_RESOLUTION: ${IMGPROXY_MAX_SRC_RESOLUTION:-50.0}
      IMGPROXY_MAX_SRC_FILE_SIZE: ${IMGPROXY_MAX_SRC_FILE_SIZE:-20971520}
      IMGPROXY_WORKERS: ${IMGPROXY_WORKERS:-100}

      # Image processing defaults
      IMGPROXY_QUALITY: ${IMGPROXY_QUALITY:-85}
      IMGPROXY_JPEG_PROGRESSIVE: ${IMGPROXY_JPEG_PROGRESSIVE:-true}
      IMGPROXY_PNG_INTERLACED: ${IMGPROXY_PNG_INTERLACED:-true}
      IMGPROXY_AUTO_WEBP: ${IMGPROXY_AUTO_WEBP:-true}
      IMGPROXY_AUTO_AVIF: ${IMGPROXY_AUTO_AVIF:-true}

      # Development mode (set to empty in production)
      IMGPROXY_DEVELOPMENT_ERRORS_MODE: ${IMGPROXY_DEVELOPMENT_ERRORS_MODE:-true}
    healthcheck:
      test: ["CMD", "imgproxy", "health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  postgres_data:
