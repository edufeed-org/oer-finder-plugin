services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    tty: true
    stdin_open: true
    command: sh -c "pnpm install --force && pnpm run build:adapters && pnpm run start:dev"
    environment:
      MODE: DEV
      BINDING: "0.0.0.0"
      COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
      NOSTR_AMB_RELAY_URL: ${NOSTR_AMB_RELAY_URL:-ws://amb-relay:3334}
      ENABLED_ADAPTERS: ${ENABLED_ADAPTERS:-nostr-amb-relay}
      RPI_VIRTUELL_API_URL: ${RPI_VIRTUELL_API_URL:-}
      IMGPROXY_BASE_URL: ${IMGPROXY_BASE_URL}
      IMGPROXY_KEY: ${IMGPROXY_KEY:-}
      IMGPROXY_SALT: ${IMGPROXY_SALT:-}
    ports:
      - "3000:3000"
      - "5173:5173"
      - "5174:5174"
    volumes:
      - .:/home/node/app
    depends_on:
      - amb-relay

  typesense:
    image: typesense/typesense:28.0
    ports:
      - "8108:8108"
    volumes:
      - typesense_data:/data
    environment:
      TYPESENSE_DATA_DIR: /data
      # IMPORTANT: Change TS_APIKEY for production deployments
      TYPESENSE_API_KEY: ${TS_APIKEY:-xyz}
    restart: unless-stopped

  amb-relay:
    build:
      context: https://github.com/JannikStreek/amb-relay.git#fix-docker-setup
      dockerfile: Dockerfile
    ports:
      - "3334:3334"
    depends_on:
      typesense:
        condition: service_started
    environment:
      NAME: ${AMB_RELAY_NAME:-AMB Relay}
      PUBKEY: ${AMB_RELAY_PUBKEY:-}
      DESCRIPTION: ${AMB_RELAY_DESCRIPTION:-Local AMB Relay}
      ICON: ${AMB_RELAY_ICON:-}
      TS_APIKEY: ${TS_APIKEY:-xyz}
      TS_HOST: http://typesense:8108
      TS_COLLECTION: ${TS_COLLECTION:-amb_events}
    restart: unless-stopped

  # nak: Nostr Army Knife CLI for sending test events to the AMB relay
  # Usage:
  #   docker compose run --rm --entrypoint sh nak /data/publish-demo-events.sh
  #   docker compose run --rm nak event -k 30142 -c '...' -t 'd=...' ws://amb-relay:3334
  nak:
    build:
      context: https://github.com/jannikstreek/nak.git#fix/docker-go-version
      dockerfile: Dockerfile
    volumes:
      - ./nak-data:/data
    profiles:
      - tools
    depends_on:
      - amb-relay

  imgproxy:
    image: ghcr.io/imgproxy/imgproxy:latest
    # network_mode: host does not work on Windows/macOS, use port mapping instead
    ports:
      - "8080:8080"
    restart: unless-stopped
    environment:
      # Port configuration (default: 8080)
      IMGPROXY_BIND: ${IMGPROXY_BIND:-:8080}

      # Security: URL signature keys (highly recommended for production)
      # Generate with: echo $(xxd -g 2 -l 64 -p /dev/random | tr -d '\n')
      IMGPROXY_KEY: ${IMGPROXY_KEY:-}
      IMGPROXY_SALT: ${IMGPROXY_SALT:-}

      # Enable URL source processing (required for proxying external images)
      IMGPROXY_ALLOW_ORIGIN: ${IMGPROXY_ALLOW_ORIGIN:-*}

      # Performance and resource limits
      IMGPROXY_MAX_SRC_RESOLUTION: ${IMGPROXY_MAX_SRC_RESOLUTION:-50.0}
      IMGPROXY_MAX_SRC_FILE_SIZE: ${IMGPROXY_MAX_SRC_FILE_SIZE:-20971520}
      IMGPROXY_WORKERS: ${IMGPROXY_WORKERS:-100}

      # Image processing defaults
      IMGPROXY_QUALITY: ${IMGPROXY_QUALITY:-85}
      IMGPROXY_JPEG_PROGRESSIVE: ${IMGPROXY_JPEG_PROGRESSIVE:-true}
      IMGPROXY_PNG_INTERLACED: ${IMGPROXY_PNG_INTERLACED:-true}
      IMGPROXY_AUTO_WEBP: ${IMGPROXY_AUTO_WEBP:-true}
      IMGPROXY_AUTO_AVIF: ${IMGPROXY_AUTO_AVIF:-true}

      # Development mode (set to empty in production)
      IMGPROXY_DEVELOPMENT_ERRORS_MODE: ${IMGPROXY_DEVELOPMENT_ERRORS_MODE:-true}
    healthcheck:
      test: ["CMD", "imgproxy", "health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  typesense_data:
